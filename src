# -*- mode: sh; -*-

temp=$(getopt -o :p: -l port: -- "$@")
eval set -- "$temp"

while [ "$1" != '--' ]; do
    case "$1" in
	-p|--port)
	    PORT=${2}
	    shift 2
	    ;;
	--)
	    shift
	    echo --
	    ;;
	*)

    esac
done

select tag in readme watch main; do
    if [ -n "$tag" ]; then
	break
    fi
done

if [ "$tag" = "readme" ]; then
    set-title README
    ## usage: run
    function run {
	(sleep 2; xdg-open "http://localhost:${PORT:=5010}/README.md") &
	python -m http.server $PORT || return
	exit
    }
    echo "Command: run"
    return
elif [ "$tag" = "watch" ]; then
    set-title Watcher
    ## usage: run
    function run {
	source .venv/bin/activate
	python watch.py || return
	exit
    }
    echo "Command: run"
    return
fi

declare -r ROOTDIR=$(dirname $(realpath "$0"))

## usage: __cleanup
function __cleanup {
    jbackup compress emacs-extensions
}
trap __cleanup EXIT

source ~/src/.gitprojectrc
source ~/src/.fzf-history

alias commit-guide="xdg-open commit-guide.html; unalias commit-guide; history -s xdg-open commit-guide.html"
alias emacs="execnohup emacs; unalias emacs; history -s execnohup emacs"
alias git-gui="execnohup --sleep 2 -n 2 git gui; unalias git-gui; history -s execnohup --sleep 2 -n 2 git gui"
alias rmcache='find -type d -iname __pycache__ -execdir rm -rfv \{} \; 2> /dev/null'

## usage: commit-doc-ext FILE
function commit-doc-ext {
    commit -t update -m "Document ${1:?missing FILE}" -ct -
}

## usage: commit-bootstrap [-c]
function commit-bootstrap {
    local tag C
    C=${1}
    read -p "Tag: " tag

    if [ "$C" = "-c" ]; then
	format-commit -c <<EOF
$tag
Bootstraps
main
EOF
    else
	commit -t $tag -m Bootstraps -ct main
    fi
}

## usage: list-commands
function list-commands {
    cat <<EOF
Commands:
  * emacs (once, modifies history)
  * git-gui (once, modifies history)
  * commit-bootstrap
  * commit-doc-ext
  * commit-guide
EOF
}

history -c
HISTFILE="$ROOTDIR/.bash_history"
HISTSIZE=500
HISTFILESIZE=500
export HISTFILE HISTSIZE HISTFILESIZE
history -r

list-commands

source .venv/bin/activate
